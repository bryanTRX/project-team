<section class="payment-section">
  <div class="container">
    <ng-container *ngIf="!showSuccess; else successState">
      <div
        class="payment-card"
        [ngClass]="{ 'text-large': textSize === 'large', 'text-xlarge': textSize === 'xlarge' }"
      >
        <div class="form-headline">
          <h1>{{ languageService.getTranslation('make_difference_today_payment') }}</h1>
          <p>{{ languageService.getTranslation('generosity_provides_safety') }}</p>
        </div>

        <form (ngSubmit)="onSubmit()" class="donation-form">
          <div
            class="form-section email-section"
            *ngIf="!isAuthenticated"
            [class.has-error]="emailSectionInvalid"
          >
            <!-- Contact Information Section -->
            <div id="contact-information" class="contact-info-section">
              <h3 class="section-subtitle">{{ languageService.getTranslation('contact_information') || 'Contact Information' }}</h3>

              <div class="input-field">
                <label for="email">{{ languageService.getTranslation('email_address') || 'Email Address' }}*</label>
                <p class="field-hint inline-under-label">
                  {{ languageService.getTranslation('email_account_notice') }}
                </p>
                <div class="input-with-icon">
                  <i class="fas fa-envelope"></i>
                  <input
                    type="email"
                    id="email"
                    [(ngModel)]="email"
                    name="email"
                    placeholder="your.email@example.com"
                    (input)="handleEmailInput()"
                    required
                  />
                </div>
              </div>

              <div class="name-fields-row">
                <div class="input-field">
                  <label for="firstName">{{ languageService.getTranslation('first_name') || 'First Name' }}*</label>
                  <div class="input-with-icon">
                    <i class="fas fa-user"></i>
                    <input
                      type="text"
                      id="firstName"
                      [(ngModel)]="firstName"
                      name="firstName"
                      [placeholder]="languageService.getTranslation('enter_first_name') || 'Enter your first name'"
                      autocomplete="given-name"
                      required
                    />
                  </div>
                </div>
                <div class="input-field">
                  <label for="lastName">{{ languageService.getTranslation('last_name') || 'Last Name' }}*</label>
                  <div class="input-with-icon">
                    <i class="fas fa-user"></i>
                    <input
                      type="text"
                      id="lastName"
                      [(ngModel)]="lastName"
                      name="lastName"
                      [placeholder]="languageService.getTranslation('enter_last_name') || 'Enter your last name'"
                      autocomplete="family-name"
                      required
                    />
                  </div>
                </div>
              </div>
              <div class="input-field">
                <label for="paymentPassword">{{
                  languageService.getTranslation('password')
                }}</label>
                <input
                  type="password"
                  id="paymentPassword"
                  [(ngModel)]="paymentPassword"
                  name="paymentPassword"
                  placeholder="{{ languageService.getTranslation('enter_password') }}"
                  autocomplete="new-password"
                />
              </div>
              <div class="checkbox-group">
                <label class="checkbox-field">
                  <input
                    type="checkbox"
                    [(ngModel)]="wishToRemainAnonymous"
                    name="wishToRemainAnonymous"
                  />
                  <span>{{ languageService.getTranslation('wish_remain_anonymous') || 'I wish to remain anonymous?' }} <i class="fas fa-question-circle"></i></span>
                </label>
                <label class="checkbox-field">
                  <input type="checkbox" [(ngModel)]="updatesOptIn" name="updatesOptIn" />
                  <span
                    >{{ languageService.getTranslation('yes_receive_updates') || "Yes, I'd like to receive impact updates and newsletters" }}
                    <i class="fas fa-question-circle"></i
                  ></span>
                </label>
              </div>

              <div class="account-flow new" *ngIf="emailMode === 'new'">
                <p>{{ languageService.getTranslation('new_account_prompt') || 'This email is not registered. Create an account to continue.' }}</p>
                <label for="newUsername">{{
                  languageService.getTranslation('create_username_label') || 'Username'
                }}</label>
                <input
                  type="text"
                  id="newUsername"
                  [(ngModel)]="newUsername"
                  name="newUsername"
                  [placeholder]="languageService.getTranslation('choose_username') || 'Choose a username'"
                  autocomplete="username"
                />
                <label for="newPassword">{{
                  languageService.getTranslation('create_password_label') || 'Create Password'
                }}</label>
                <input
                  type="password"
                  id="newPassword"
                  [(ngModel)]="newPassword"
                  name="newPassword"
                  [placeholder]="languageService.getTranslation('create_password') || 'Create a password'"
                  autocomplete="new-password"
                />
              </div>
              <div class="account-flow existing" *ngIf="emailMode === 'existing'">
                <p>{{ languageService.getTranslation('existing_account_prompt') || 'This email is already registered. Enter your password to continue.' }}</p>
                <label for="existingPassword">{{
                  languageService.getTranslation('existing_account_password_label') || 'Password'
                }}</label>
                <input
                  type="password"
                  id="existingPassword"
                  [(ngModel)]="loginPassword"
                  name="loginPassword"
                  [placeholder]="languageService.getTranslation('enter_password') || 'Enter your password'"
                  autocomplete="current-password"
                />
              </div>
            </div>

            <!-- Address Section -->
            <div class="address-section">
              <h3 class="section-subtitle">{{ languageService.getTranslation('address') || 'Address' }}</h3>

              <div class="input-field">
                <label for="address">{{ languageService.getTranslation('street_address_line1') || 'Street Address (Line 1)' }}*</label>
                <div class="input-with-icon">
                  <i class="fas fa-map-marker-alt"></i>
                  <input
                    type="text"
                    id="address"
                    [(ngModel)]="address"
                    name="address"
                    [placeholder]="languageService.getTranslation('enter_address') || 'Enter your address'"
                    autocomplete="street-address"
                    required
                  />
                </div>
              </div>

              <div class="input-field">
                <label for="addressLine2">{{ languageService.getTranslation('street_address_line2') || 'Street Address (Line 2) (Optional)' }}</label>
                <div class="input-with-icon">
                  <i class="fas fa-map-marker-alt"></i>
                  <input
                    type="text"
                    id="addressLine2"
                    [(ngModel)]="addressLine2"
                    name="addressLine2"
                    [placeholder]="languageService.getTranslation('apartment_suite') || 'Apartment, suite, etc.'"
                    autocomplete="address-line2"
                  />
                </div>
              </div>

              <div class="address-fields-row">
                <div class="input-field">
                  <label for="city">{{ languageService.getTranslation('city') || 'City' }}*</label>
                  <input
                    type="text"
                    id="city"
                    [(ngModel)]="city"
                    name="city"
                    [placeholder]="languageService.getTranslation('enter_city') || 'Enter your city'"
                    autocomplete="address-level2"
                    required
                  />
                </div>
                <div class="input-field">
                  <label for="country">{{ languageService.getTranslation('country') || 'Country' }}*</label>
                  <select
                    id="country"
                    [(ngModel)]="country"
                    name="country"
                    autocomplete="country"
                    required
                  >
                    <option value="Canada">Canada</option>
                    <option value="United States">United States</option>
                    <option value="Other">{{ languageService.getTranslation('other') || 'Other' }}</option>
                  </select>
                </div>
              </div>

              <div class="address-fields-row">
                <div class="input-field">
                  <label for="province">{{ languageService.getTranslation('province_state') || 'Province/State' }}*</label>
                  <select
                    id="province"
                    [(ngModel)]="province"
                    name="province"
                    autocomplete="address-level1"
                    required
                  >
                    <option value="">{{ languageService.getTranslation('select_province_state') || 'Select province/state' }}</option>
                    <option value="Quebec">Quebec</option>
                    <option value="Ontario">Ontario</option>
                    <option value="British Columbia">British Columbia</option>
                    <option value="Alberta">Alberta</option>
                    <option value="Manitoba">Manitoba</option>
                    <option value="Saskatchewan">Saskatchewan</option>
                    <option value="Nova Scotia">Nova Scotia</option>
                    <option value="New Brunswick">New Brunswick</option>
                    <option value="Newfoundland and Labrador">Newfoundland and Labrador</option>
                    <option value="Prince Edward Island">Prince Edward Island</option>
                    <option value="Northwest Territories">Northwest Territories</option>
                    <option value="Yukon">Yukon</option>
                    <option value="Nunavut">Nunavut</option>
                  </select>
                </div>
                <div class="input-field">
                  <label for="postalCode">{{ languageService.getTranslation('postal_code_zip') || 'Postal Code/ZIP' }}*</label>
                  <input
                    type="text"
                    id="postalCode"
                    [(ngModel)]="postalCode"
                    name="postalCode"
                    [placeholder]="languageService.getTranslation('enter_postal_code') || 'Enter your postal code'"
                    autocomplete="postal-code"
                    required
                  />
                </div>
              </div>

              <div class="input-field">
                <label for="phoneNumber">{{ languageService.getTranslation('phone_number') || 'Phone Number' }}</label>
                <input
                  type="tel"
                  id="phoneNumber"
                  [(ngModel)]="phoneNumber"
                  name="phoneNumber"
                  [placeholder]="languageService.getTranslation('phone_placeholder') || '(555) 123-4567'"
                  autocomplete="tel"
                />
              </div>
            </div>
          </div>

          <div class="form-section amount-section">
            <label>{{ languageService.getTranslation('choose_donation_amount') || 'Choose Donation Amount' }}</label>
            <div class="amount-options">
              <button
                type="button"
                *ngFor="let option of donationOptions"
                (click)="selectDonationAmount(option)"
                [class.active]="donationAmount === option"
              >
                {{ option | currency: 'USD' : 'symbol' : '1.0-0' }}
              </button>
            </div>
            <div class="custom-amount">
              <label for="customAmount">{{
                languageService.getTranslation('or_enter_custom_amount') || 'Or enter custom amount'
              }}</label>
              <div class="custom-input">
                <span class="currency-symbol">$</span>
                <input
                  type="number"
                  id="customAmount"
                  name="customAmount"
                  min="1"
                  step="1"
                  placeholder="0.00"
                  [(ngModel)]="customAmount"
                  (input)="onCustomAmountChange()"
                />
              </div>
            </div>
          </div>

          <div class="form-section frequency-section">
            <label>{{ languageService.getTranslation('donation_frequency') || 'Donation Frequency' }}</label>
            <p class="frequency-subtext">
              <span aria-hidden="true">üí´</span>
              {{ languageService.getTranslation('recurring_helps_plan') || 'Recurring donations help us plan and provide consistent support.' }}
            </p>
            <div class="frequency-options">
              <button
                type="button"
                class="frequency-card"
                *ngFor="let option of frequencyOptions"
                (click)="selectFrequency(option.value)"
                [class.active]="recurringOption === option.value"
              >
                <div class="freq-header">
                  <span class="freq-label">{{ option.label }}</span>
                  <span class="freq-badge" *ngIf="option.highlight">{{ option.highlight }}</span>
                </div>
                <span class="freq-description">{{ option.description }}</span>
              </button>
            </div>
          </div>

          <div class="form-section payment-method-section">
            <label>{{ languageService.getTranslation('payment_method') || 'Payment Method' }}</label>
            <p class="payment-subtext">
              <span aria-hidden="true">üîê</span>
              {{ languageService.getTranslation('all_info_confidential') || 'All information is encrypted and confidential' }}
            </p>
            <div class="payment-methods">
              <button
                type="button"
                *ngFor="let method of paymentMethods"
                (click)="selectPaymentMethod(method.value)"
                [class.active]="selectedPaymentMethod === method.value"
              >
                <div class="method-header">
                  <i [class]="method.icon"></i>
                  <span>{{ method.label }}</span>
                </div>
                <div class="method-badges">
                  <span *ngFor="let badge of method.badges">{{ badge }}</span>
                </div>
              </button>
            </div>
            <div class="card-details" *ngIf="selectedPaymentMethod === 'card'">
              <div class="card-panel">
                <div class="card-panel-header">
                  <div class="header-icon">
                    <i class="far fa-credit-card"></i>
                  </div>
                  <p class="panel-title">
                    {{ languageService.getTranslation('payment_information') || 'Payment Information' }}
                  </p>
                </div>
                <div class="card-grid">
                  <div class="card-field full-width">
                    <label for="cardNumber">{{
                      languageService.getTranslation('card_number') || 'Card Number'
                    }}</label>
                    <input
                      type="text"
                      id="cardNumber"
                      [(ngModel)]="cardNumber"
                      name="cardNumber"
                      [placeholder]="languageService.getTranslation('card_number_placeholder') || '1234 5678 9012 3456'"
                      (input)="formatCardNumber()"
                      maxlength="19"
                      required
                    />
                  </div>
                  <div class="card-field full-width">
                    <label for="cardHolder">{{
                      languageService.getTranslation('card_holder_name') || 'Card Holder Name'
                    }}</label>
                    <input
                      type="text"
                      id="cardHolder"
                      [(ngModel)]="cardHolder"
                      name="cardHolder"
                      [placeholder]="languageService.getTranslation('card_holder_placeholder') || 'John Doe'"
                      required
                    />
                  </div>
                  <div class="card-field">
                    <label for="expiryDate">{{
                      languageService.getTranslation('expiry_date') || 'Expiry Date'
                    }}</label>
                    <input
                      type="text"
                      id="expiryDate"
                      [(ngModel)]="expiryDate"
                      name="expiryDate"
                      placeholder="MM/YY"
                      (input)="formatExpiryDate()"
                      maxlength="5"
                      required
                    />
                  </div>
                  <div class="card-field">
                    <label for="cvv">{{ languageService.getTranslation('cvv') || 'CVV' }}</label>
                    <input
                      type="text"
                      id="cvv"
                      [(ngModel)]="cvv"
                      name="cvv"
                      placeholder="123"
                      (input)="formatCvv()"
                      maxlength="4"
                      required
                    />
                  </div>
                </div>
              </div>
            </div>
            <div class="method-detail paypal-detail" *ngIf="selectedPaymentMethod === 'paypal'">
              <div class="paypal-logo" aria-hidden="true">
                <svg
                  viewBox="0 0 120 40"
                  xmlns="http://www.w3.org/2000/svg"
                  role="presentation"
                  focusable="false"
                >
                  <rect width="120" height="40" rx="8" fill="url(#paypalGradient)" />
                  <defs>
                    <linearGradient id="paypalGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stop-color="#009cde" />
                      <stop offset="100%" stop-color="#003087" />
                    </linearGradient>
                  </defs>
                  <text
                    x="60"
                    y="26"
                    text-anchor="middle"
                    font-family="'Helvetica Neue', Arial, sans-serif"
                    font-size="18"
                    font-weight="700"
                    fill="#fff"
                  >
                    PayPal
                  </text>
                </svg>
              </div>
              <div>
                <p>{{ languageService.getTranslation('complete_gift_paypal') || 'Complete your gift securely through PayPal.' }}</p>
                <a
                  class="paypal-link"
                  href="https://www.paypal.com/donate"
                  target="_blank"
                  rel="noopener"
                >
                  {{ languageService.getTranslation('go_to_paypal') || 'Go to PayPal' }}
                </a>
              </div>
            </div>
            <div class="method-detail phone-detail" *ngIf="selectedPaymentMethod === 'phone'">
              <i class="fas fa-phone-alt"></i>
              <div class="phone-details-form">
                <p>{{ languageService.getTranslation('phone_donation_note') || 'After you click Complete Donation, an agent will call to finalize your gift.' }}</p>
                <div class="phone-form-fields" *ngIf="!isAuthenticated">
                  <div class="phone-field">
                    <label for="phonePassword">{{
                      languageService.getTranslation('password') || 'Password'
                    }}</label>
                    <input
                      type="password"
                      id="phonePassword"
                      [(ngModel)]="phonePassword"
                      name="phonePassword"
                      [placeholder]="languageService.getTranslation('enter_password') || 'Enter your password'"
                      autocomplete="new-password"
                    />
                  </div>
                </div>
              </div>
            </div>
            <div class="payment-security-note">
              <p>{{ languageService.getTranslation('donation_secure_tax_deductible') || 'Your donation is secure and tax-deductible.' }}</p>
            </div>
          </div>

          <button type="submit" class="submit-payment-btn">
            <i class="fas fa-heart"></i>
            <span>{{ languageService.getTranslation('complete_donation') || 'Complete Donation' }}</span>
          </button>
        </form>
      </div>
    </ng-container>

    <ng-template #successState>
      <div class="success-message">
        <div class="success-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <h2>{{ languageService.getTranslation('thank_you') || 'Thank You!' }}</h2>
        <p>{{ getDonationProcessedText(donationAmount) }}</p>
        <p>{{ languageService.getTranslation('confirmation_email_shortly') || 'A confirmation email will be sent to you shortly.' }}</p>
        <div class="success-animation">
          <i class="fas fa-heart"></i>
        </div>
        <button class="ok-btn" (click)="redirectToDashboard()">{{ languageService.getTranslation('ok') || 'OK' }}</button>
      </div>
    </ng-template>
  </div>
</section>
