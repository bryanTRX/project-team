<section class="payment-section">
  <div class="container">
    <ng-container *ngIf="!showSuccess; else successState">
      <div
        class="payment-card"
        [ngClass]="{ 'text-large': textSize === 'large', 'text-xlarge': textSize === 'xlarge' }"
      >
        <div class="accessibility-panel" *ngIf="showAccessibilityPanel">
          <div class="panel-row">
            <div>
              <p class="panel-title">{{ languageService.getTranslation('simple_mode') }}</p>
              <span class="panel-subtitle">{{
                languageService.getTranslation('show_only_essential')
              }}</span>
            </div>
            <label class="toggle-switch">
              <input
                type="checkbox"
                name="simpleMode"
                [(ngModel)]="simpleMode"
                (change)="trackSimpleModeChange()"
              />
              <span class="slider"></span>
            </label>
          </div>
          <div class="panel-row">
            <div class="panel-label">
              <i class="fas fa-text-height"></i>
              <span>{{ languageService.getTranslation('text_size') }}</span>
            </div>
            <select [(ngModel)]="textSize" name="textSize">
              <option *ngFor="let option of textSizeOptions" [value]="option.value">
                {{ option.label }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-headline">
          <div class="headline-row">
            <h1>{{ languageService.getTranslation('make_difference_today_payment') }}</h1>
            <button class="accessibility-btn" type="button" (click)="toggleAccessibilityPanel()">
              <i class="fas fa-universal-access"></i>
              <span>{{ languageService.getTranslation('accessibility_settings') }}</span>
            </button>
          </div>
          <p>{{ languageService.getTranslation('generosity_provides_safety') }}</p>
        </div>

        <form (ngSubmit)="onSubmit()" class="donation-form">
          <div
            class="form-section email-section"
            *ngIf="!isAuthenticated"
            [class.has-error]="emailSectionInvalid"
          >
            <label for="email">{{ languageService.getTranslation('email_address') }}</label>
            <p class="field-hint inline-under-label">
              {{ languageService.getTranslation('email_account_notice') }}
            </p>
            <div class="input-with-icon">
              <i class="fas fa-envelope"></i>
              <input
                type="email"
                id="email"
                [(ngModel)]="email"
                name="email"
                placeholder="your.email@example.com"
                (input)="handleEmailInput()"
                required
              />
            </div>
            <div class="account-flow new" *ngIf="emailMode === 'new'">
              <p>{{ languageService.getTranslation('new_account_prompt') }}</p>
              <label for="newUsername">{{
                languageService.getTranslation('create_username_label')
              }}</label>
              <input
                type="text"
                id="newUsername"
                [(ngModel)]="newUsername"
                name="newUsername"
                placeholder="Choose a username"
                autocomplete="username"
              />
              <label for="newPassword">{{
                languageService.getTranslation('create_password_label')
              }}</label>
              <input
                type="password"
                id="newPassword"
                [(ngModel)]="newPassword"
                name="newPassword"
                placeholder="Create a password"
                autocomplete="new-password"
              />
            </div>
            <div class="account-flow existing" *ngIf="emailMode === 'existing'">
              <p>{{ languageService.getTranslation('existing_account_prompt') }}</p>
              <label for="existingPassword">{{
                languageService.getTranslation('existing_account_password_label')
              }}</label>
              <input
                type="password"
                id="existingPassword"
                [(ngModel)]="loginPassword"
                name="loginPassword"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                autocomplete="current-password"
              />
            </div>
            <div class="inline-updates-card" *ngIf="!simpleMode">
              <p class="info-description">
                {{ languageService.getTranslation('receive_stories_updates') }}
              </p>
              <label class="checkbox-field">
                <input type="checkbox" [(ngModel)]="updatesOptIn" name="updatesOptIn" />
                <span>{{ languageService.getTranslation('yes_receive_updates') }}</span>
              </label>
            </div>
          </div>

          <div class="form-section amount-section">
            <label>{{ languageService.getTranslation('choose_donation_amount') }}</label>
            <div class="amount-options">
              <button
                type="button"
                *ngFor="let option of donationOptions"
                (click)="selectDonationAmount(option)"
                [class.active]="donationAmount === option"
              >
                {{ option | currency: 'USD' : 'symbol' : '1.0-0' }}
              </button>
            </div>
            <div class="custom-amount">
              <label for="customAmount">{{
                languageService.getTranslation('or_enter_custom_amount')
              }}</label>
              <div class="custom-input">
                <span class="currency-symbol">$</span>
                <input
                  type="number"
                  id="customAmount"
                  name="customAmount"
                  min="1"
                  step="1"
                  placeholder="0.00"
                  [(ngModel)]="customAmount"
                  (input)="onCustomAmountChange()"
                />
              </div>
            </div>
          </div>

          <div class="form-section frequency-section">
            <label>{{ languageService.getTranslation('donation_frequency') }}</label>
            <p class="frequency-subtext">
              <span aria-hidden="true">üí´</span>
              {{ languageService.getTranslation('recurring_helps_plan') }}
            </p>
            <div class="frequency-options">
              <button
                type="button"
                class="frequency-card"
                *ngFor="let option of frequencyOptions"
                (click)="selectFrequency(option.value)"
                [class.active]="recurringOption === option.value"
              >
                <div class="freq-header">
                  <span class="freq-label">{{ option.label }}</span>
                  <span class="freq-badge" *ngIf="option.highlight">{{ option.highlight }}</span>
                </div>
                <span class="freq-description">{{ option.description }}</span>
              </button>
            </div>
          </div>

          <div class="form-section payment-method-section">
            <label>{{ languageService.getTranslation('payment_method') }}</label>
            <p class="payment-subtext">
              <span aria-hidden="true">üîê</span>
              {{ languageService.getTranslation('all_info_confidential') }}
            </p>
            <div class="payment-methods">
              <button
                type="button"
                *ngFor="let method of paymentMethods"
                (click)="selectPaymentMethod(method.value)"
                [class.active]="selectedPaymentMethod === method.value"
              >
                <div class="method-header">
                  <i [class]="method.icon"></i>
                  <span>{{ method.label }}</span>
                </div>
                <div class="method-badges">
                  <span *ngFor="let badge of method.badges">{{ badge }}</span>
                </div>
              </button>
            </div>
            <div class="card-details" *ngIf="selectedPaymentMethod === 'card'">
              <div class="card-panel">
                <div class="card-panel-header">
                  <div class="header-icon">
                    <i class="far fa-credit-card"></i>
                  </div>
                  <p class="panel-title">
                    {{ languageService.getTranslation('payment_information') }}
                  </p>
                </div>
                <div class="card-grid">
                  <div class="card-field full-width">
                    <label for="cardNumber">{{
                      languageService.getTranslation('card_number')
                    }}</label>
                    <input
                      type="text"
                      id="cardNumber"
                      [(ngModel)]="cardNumber"
                      name="cardNumber"
                      placeholder="1234 5678 9012 3456"
                      (input)="formatCardNumber()"
                      maxlength="19"
                      required
                    />
                  </div>
                  <div class="card-field full-width">
                    <label for="cardHolder">{{
                      languageService.getTranslation('card_holder_name')
                    }}</label>
                    <input
                      type="text"
                      id="cardHolder"
                      [(ngModel)]="cardHolder"
                      name="cardHolder"
                      placeholder="John Doe"
                      required
                    />
                  </div>
                  <div class="card-field">
                    <label for="expiryDate">{{
                      languageService.getTranslation('expiry_date')
                    }}</label>
                    <input
                      type="text"
                      id="expiryDate"
                      [(ngModel)]="expiryDate"
                      name="expiryDate"
                      placeholder="MM/YY"
                      (input)="formatExpiryDate()"
                      maxlength="5"
                      required
                    />
                  </div>
                  <div class="card-field">
                    <label for="cvv">{{ languageService.getTranslation('cvv') }}</label>
                    <input
                      type="text"
                      id="cvv"
                      [(ngModel)]="cvv"
                      name="cvv"
                      placeholder="123"
                      (input)="formatCvv()"
                      maxlength="4"
                      required
                    />
                  </div>
                </div>
              </div>
            </div>
            <div class="method-detail paypal-detail" *ngIf="selectedPaymentMethod === 'paypal'">
              <div class="paypal-logo" aria-hidden="true">
                <svg
                  viewBox="0 0 120 40"
                  xmlns="http://www.w3.org/2000/svg"
                  role="presentation"
                  focusable="false"
                >
                  <rect width="120" height="40" rx="8" fill="url(#paypalGradient)" />
                  <defs>
                    <linearGradient id="paypalGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stop-color="#009cde" />
                      <stop offset="100%" stop-color="#003087" />
                    </linearGradient>
                  </defs>
                  <text
                    x="60"
                    y="26"
                    text-anchor="middle"
                    font-family="'Helvetica Neue', Arial, sans-serif"
                    font-size="18"
                    font-weight="700"
                    fill="#fff"
                  >
                    PayPal
                  </text>
                </svg>
              </div>
              <div>
                <p>Complete your gift securely through PayPal.</p>
                <a
                  class="paypal-link"
                  href="https://www.paypal.com/donate"
                  target="_blank"
                  rel="noopener"
                >
                  Go to PayPal
                </a>
              </div>
            </div>
            <div class="method-detail phone-detail" *ngIf="selectedPaymentMethod === 'phone'">
              <i class="fas fa-phone-alt"></i>
              <div>
                <p>After you click Complete Donation, an agent will call to finalize your gift.</p>
              </div>
            </div>
            <div class="payment-security-note">
              <p>{{ languageService.getTranslation('donation_secure_tax_deductible') }}</p>
            </div>
          </div>

          <button type="submit" class="submit-payment-btn">
            <i class="fas fa-heart"></i>
            <span>{{ languageService.getTranslation('complete_donation') }}</span>
          </button>
        </form>
      </div>
    </ng-container>

    <ng-template #successState>
      <div class="success-message">
        <div class="success-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <h2>{{ languageService.getTranslation('thank_you') }}</h2>
        <p>{{ getDonationProcessedText(donationAmount) }}</p>
        <p>{{ languageService.getTranslation('confirmation_email_shortly') }}</p>
        <div class="success-animation">
          <i class="fas fa-heart"></i>
        </div>
        <button class="ok-btn" (click)="redirectToDashboard()">OK</button>
      </div>
    </ng-template>
  </div>
</section>
