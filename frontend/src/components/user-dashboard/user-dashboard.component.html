<!-- Hidden tier badges component for calculations -->
<app-tier-badges [totalDonated]="user?.totalDonated || 0" style="display: none;"></app-tier-badges>

<section class="dashboard-page" *ngIf="user">
  <div class="dashboard-container">
    <div class="impact-dashboard">
      <div class="dashboard-header">
        <div>
          <p class="eyebrow">Your Impact Dashboard</p>
          <h1>See how your generosity is making a difference</h1>
        </div>
        <div class="header-actions">
          <button class="primary-btn" (click)="startNewDonation()">
            <i class="fas fa-plus"></i>
            Make a New Donation
          </button>
          <button class="outline-btn">Manage Your Donation Plan</button>
          <button class="ghost-btn subtle" routerLink="/">Back to Site</button>
          <button class="ghost-btn logout" (click)="logout()">Log out</button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <p>Total Donated</p>
          <span class="stat-value">{{ user.totalDonated | currency:'USD':'symbol':'1.0-0' }}</span>
        </div>
        <div class="stat-card">
          <p>Families Helped</p>
          <span class="stat-value">{{ user.familiesHelped }}</span>
        </div>
        <div class="stat-card tier-card" *ngIf="currentTier">
          <p>Donor Tier</p>
          <div class="tier-display">
            <img [src]="currentTier.imagePath" [alt]="currentTier.name + ' tier badge'" class="tier-badge-img" />
            <div class="tier-info">
              <span class="tier-name">{{ currentTier.name }}</span>
              <span class="tier-subtitle">{{ currentTier.subtitle }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="progress-card" *ngIf="nextTier">
        <div class="progress-head">
          <div class="progress-tier-info">
            <img [src]="nextTier.imagePath" [alt]="nextTier.name + ' tier badge'" class="progress-tier-badge" />
            <div>
              <p>Path to {{ nextTier.name }} Status</p>
              <span class="progress-tier-subtitle">{{ nextTier.subtitle }}</span>
            </div>
          </div>
          <span>{{ progressPercentage }}% Complete</span>
        </div>
        <div class="progress-bar">
          <div class="fill" [style.width.%]="progressPercentage"></div>
        </div>
        <p>Reach {{ nextTier.name }} status at {{ nextTier.minAmount | currency:'USD':'symbol':'1.0-0' }} donated ({{ getAmountToNextTier() | currency:'USD':'symbol':'1.0-0' }} to go)</p>
      </div>
      <div class="progress-card max-tier" *ngIf="!nextTier && currentTier">
        <div class="progress-head">
          <div class="progress-tier-info">
            <img [src]="currentTier.imagePath" [alt]="currentTier.name + ' tier badge'" class="progress-tier-badge" />
            <div>
              <p>{{ currentTier.name }} Status - Maximum Tier!</p>
              <span class="progress-tier-subtitle">{{ currentTier.subtitle }}</span>
            </div>
          </div>
          <span>100% Complete</span>
        </div>
        <div class="progress-bar">
          <div class="fill" style="width: 100%"></div>
        </div>
        <p>Congratulations! You've reached the highest tier of support.</p>
      </div>

      <div class="info-grid">
        <div class="impact-news card-panel">
          <div class="panel-head">
            <div>
              <h2>Impact News</h2>
              <p>See how your donations are making a difference</p>
            </div>
          </div>
          <div class="news-items">
            @for (item of news; track item.title) {
              <article class="news-item">
                <div>
                  <span class="news-badge">{{ item.label }}</span>
                  <h3>{{ item.title }}</h3>
                  <p>{{ item.description }}</p>
                </div>
                <span class="news-date">{{ item.date }}</span>
              </article>
            }
          </div>
          <a class="panel-link">Read All News</a>
        </div>

        <div class="history-forum">
          <div class="history card-panel">
            <div class="panel-head">
              <h2>Donation History</h2>
              <a class="panel-link small">View Full History</a>
            </div>
            <div class="history-items">
              @for (donation of donationHistory; track donation.date) {
                <div class="history-row">
                  <div>
                    <p class="history-date">{{ donation.date }}</p>
                    <span class="history-frequency">{{ donation.frequency }}</span>
                  </div>
                  <span class="history-amount">{{ donation.amount | currency:'USD':'symbol':'1.0-0' }}</span>
                </div>
              }
            </div>
          </div>

          <div class="forum card-panel">
            <div class="panel-head">
              <div>
                <h2>Community Forum</h2>
                <p>Connect with fellow supporters and share impact stories</p>
              </div>
              <div class="forum-stats">
                <div>
                  <p>847</p>
                  <span>Members</span>
                </div>
                <div>
                  <p>156</p>
                  <span>Discussions</span>
                </div>
              </div>
            </div>
            <div class="forum-discussions">
              @for (discussion of discussions; track discussion.title) {
                <div class="discussion-row">
                  <p>{{ discussion.title }}</p>
                  <span>{{ discussion.replies }} replies</span>
                </div>
              }
            </div>
            <button class="primary-btn ghost">Visit Forum</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
