<app-tier-badges
  [totalDonated]="user?.totalDonated || 0"
  (tiersUpdated)="onTiersUpdated($event)"
  style="display: none"
></app-tier-badges>

<section class="dashboard-page" *ngIf="user">
  <div class="dashboard-container">
    <div class="impact-dashboard">
      <div class="dashboard-section card-panel">
        <div class="dashboard-header">
          <div>
            <h2>{{ languageService.getTranslation('your_impact_dashboard') }}</h2>
            <p class="dashboard-subtitle">
              {{ languageService.getTranslation('see_generosity_making_difference') }}
            </p>
          </div>
        </div>

        <div class="stats-actions-row">
          <div class="stat-card">
            <div class="stat-content">
              <p>{{ languageService.getTranslation('total_donated') }}</p>
              <span class="stat-value">{{
                user.totalDonated | currency: 'USD' : 'symbol' : '1.0-0'
              }}</span>
            </div>
            <span class="stat-icon heart"><i class="fas fa-heart"></i></span>
          </div>

          <div class="stat-card">
            <div class="stat-content">
              <p>{{ languageService.getTranslation('lives_touched') }}</p>
              <span class="stat-value">{{ formatNumber(user.familiesHelped) }}</span>
            </div>
            <span class="stat-icon group"><i class="fas fa-user-friends"></i></span>
          </div>

          <div
            class="stat-card tier-card"
            (click)="onTierCardClick()"
            style="cursor: pointer; position: relative"
          >
            <div class="stat-content">
              <p>{{ languageService.getTranslation('donor_tier') }}</p>
              <span class="stat-value">{{ (currentTier && currentTier.name) || languageService.getTranslation('dedicated_supporter') }}</span>
            </div>
            <div class="stat-icon badge" *ngIf="currentTier">
              <img
                [src]="currentTier.imagePath"
                [alt]="currentTier.name + ' tier badge'"
                class="tier-badge-image"
              />
            </div>
            <span class="stat-icon badge" *ngIf="!currentTier"><i class="fas fa-ribbon"></i></span>
            <button
              class="tier-toggle-btn"
              (click)="onTierCardClick(); $event.stopPropagation()"
              [attr.aria-label]="showTierPopup ? 'Close tiers' : 'View tiers'"
            >
              <i
                class="fas"
                [class.fa-chevron-up]="showTierPopup"
                [class.fa-chevron-down]="!showTierPopup"
              ></i>
            </button>
          </div>

          <!-- Tier Popup Modal - Outside tier-card to avoid layout issues -->
          <div class="tier-popup-overlay" *ngIf="showTierPopup" (click)="closeTierPopup()">
            <div class="tier-popup-modal" (click)="$event.stopPropagation()">
              <div class="tier-popup-header">
                <div class="tier-popup-header-content">
                  <h3>
                    {{
                      languageService.getTranslation('donor_tiers_benefits') ||
                        'Donor Tiers & Benefits'
                    }}
                  </h3>
                  <p class="tier-popup-subtitle-header">
                    {{
                      languageService.getTranslation('discover_donation_levels') ||
                        'Discover all donation levels and their exclusive benefits'
                    }}
                  </p>
                </div>
                <button class="tier-popup-close" (click)="closeTierPopup()" aria-label="Close">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="tier-popup-content">
                <div
                  class="tier-popup-item"
                  *ngFor="let tier of allTiers"
                  [class.current-tier]="isCurrentTier(tier)"
                >
                  <div class="tier-popup-item-header">
                    <div class="tier-popup-image">
                      <img [src]="tier.imagePath" [alt]="tier.name + ' tier badge'" />
                    </div>
                    <div class="tier-popup-info">
                      <h4 class="tier-popup-name">{{ tier.name }}</h4>
                      <p class="tier-popup-subtitle">{{ tier.subtitle }}</p>
                      <p class="tier-popup-amount">{{ getTierAmountRange(tier) }}</p>
                    </div>
                    <div class="tier-popup-badge" *ngIf="isCurrentTier(tier)">
                      <span class="current-badge">
                        <i class="fas fa-check-circle"></i>
                        {{
                          languageService.getTranslation('your_current_tier') || 'Your Current Tier'
                        }}
                      </span>
                    </div>
                  </div>
                  <p class="tier-popup-description">{{ getTierDescription(tier) }}</p>
                  <div class="tier-popup-benefits">
                    <h5 class="benefits-title">
                      <i class="fas fa-gift"></i>
                      {{ languageService.getTranslation('benefits') || 'Benefits' }}
                    </h5>
                    <ul>
                      <li *ngFor="let benefit of tier.benefits">
                        <i class="fas fa-check"></i>
                        <span>{{ languageService.getTranslation(benefit) || benefit }}</span>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="tier-popup-footer">
                <button
                  class="tier-popup-donate-btn"
                  (click)="startNewDonation(); closeTierPopup()"
                >
                  <i class="fas fa-heart"></i>
                  {{ languageService.getTranslation('make_donation') || 'Make a Donation' }}
                </button>
              </div>
            </div>
          </div>

          <div class="action-cards">
            <button class="primary-btn large" (click)="startNewDonation()">
              <i class="fas fa-plus"></i>
              {{ languageService.getTranslation('make_new_donation') }}
            </button>
            <button class="outline-btn large">
              {{ languageService.getTranslation('manage_donation_plan') }}
            </button>
          </div>
        </div>

        <div class="progress-row" *ngIf="user">
          <ng-container *ngIf="nextTier; else maxTierCard">
            <div class="progress-card">
              <div class="progress-head">
                <div class="progress-tier-info">
                  <img
                    [src]="nextTier.imagePath"
                    [alt]="nextTier.name + ' tier badge'"
                    class="progress-tier-badge"
                  />
                  <div>
                    <p>{{ getPathToStatusText(nextTier.name) }}</p>
                    <span class="progress-tier-subtitle member-since">
                      {{ languageService.getTranslation('member_since') }} {{ memberSinceDate }}
                    </span>
                  </div>
                </div>
                <span
                  >{{ progressPercentage }}% {{ languageService.getTranslation('complete') }}</span
                >
              </div>
              <div class="progress-bar">
                <div class="fill" [style.width.%]="progressPercentage"></div>
              </div>
              <p class="progress-summary">
                {{
                  getReachTierStatusText(nextTier.name, nextTier.minAmount, getAmountToNextTier())
                }}
              </p>
            </div>
          </ng-container>

          <ng-template #maxTierCard>
            <div class="progress-card max-tier">
              <div class="progress-head">
                <div class="progress-tier-info">
                  <img
                    *ngIf="currentTier"
                    [src]="currentTier.imagePath"
                    [alt]="currentTier.name + ' tier badge'"
                    class="progress-tier-badge"
                  />
                  <div>
                    <p>
                      {{ ((currentTier && currentTier.name) || (languageService.getTranslation('tier') || 'Tier')) + ' ' + languageService.getTranslation('maximum_tier') }}
                    </p>
                    <span class="progress-tier-subtitle member-since">
                      {{ languageService.getTranslation('member_since') }} {{ memberSinceDate }}
                    </span>
                  </div>
                </div>
                <span>100% {{ languageService.getTranslation('complete') }}</span>
              </div>
              <div class="progress-bar">
                <div class="fill" style="width: 100%"></div>
              </div>
              <p class="progress-summary">
                {{ languageService.getTranslation('congratulations_highest_tier') }}
              </p>
            </div>
          </ng-template>

          <div class="progress-card goal-card">
            <div class="progress-head">
              <div class="progress-tier-info">
                <div>
                  <p>{{ languageService.getTranslation('personal_giving_goal') }}</p>
                  <span class="progress-tier-subtitle">
                    {{ languageService.getTranslation('goal_label') }}
                    {{ personalGoalTarget | currency: 'USD' : 'symbol' : '1.0-0' }}
                  </span>
                </div>
              </div>
              <span
                >{{ personalGoalProgress }}% {{ languageService.getTranslation('complete') }}</span
              >
            </div>
            <div class="progress-bar">
              <div class="fill" [style.width.%]="personalGoalProgress"></div>
            </div>
            <p class="progress-summary" *ngIf="personalGoalRemaining > 0">
              {{ personalGoalRemaining | currency: 'USD' : 'symbol' : '1.0-0' }}
              {{ languageService.getTranslation('goal_remaining_suffix') }}
            </p>
            <p class="progress-summary" *ngIf="personalGoalRemaining === 0">
              {{ languageService.getTranslation('goal_complete_message') }}
            </p>
          </div>
        </div>
      </div>

      <div class="info-grid">
        <div class="impact-news card-panel">
          <div class="panel-head">
            <div>
              <h2>{{ languageService.getTranslation('impact_news') }}</h2>
              <p>{{ languageService.getTranslation('see_donations_making_difference') }}</p>
            </div>
          </div>
          <div class="news-items">
            @for (item of news; track item.title) {
              <article class="news-item">
                <div>
                  <span class="news-badge">
                    {{
                      item.label === 'Program Update'
                        ? languageService.getTranslation('program_update')
                        : item.label === 'Milestone'
                          ? languageService.getTranslation('milestone')
                          : item.label
                    }}
                  </span>
                  <h3>{{ item.title }}</h3>
                  <p>{{ item.description }}</p>
                </div>
                <span class="news-date">{{ item.date }}</span>
              </article>
            }
          </div>
          <button class="panel-link news-button" type="button">
            {{ languageService.getTranslation('read_all_news') }} &rarr;
          </button>
        </div>

        <div class="history-forum">
          <div class="forum card-panel">
            <div class="panel-head">
              <div class="forum-head-text">
                <h2>{{ languageService.getTranslation('community_forum') }}</h2>
                <p>{{ languageService.getTranslation('connect_with_supporters') }}</p>
                <span class="forum-subtitle">
                  <i class="fas fa-fire"></i>
                  {{ languageService.getTranslation('trending_discussions') }}
                </span>
              </div>
              <div class="forum-stats">
                <div class="forum-stat-card">
                  <span class="stat-icon soft">
                    <i class="fas fa-user-friends"></i>
                  </span>
                  <p class="stat-number">847</p>
                  <span class="stat-label">{{ languageService.getTranslation('members') }}</span>
                </div>
                <div class="forum-stat-card">
                  <span class="stat-icon soft">
                    <i class="fas fa-comments"></i>
                  </span>
                  <p class="stat-number">156</p>
                  <span class="stat-label">{{
                    languageService.getTranslation('discussions')
                  }}</span>
                </div>
              </div>
            </div>
            <div class="forum-discussions">
              @for (discussion of discussions; track discussion.title) {
                <div class="discussion-row">
                  <p>{{ discussion.title }}</p>
                  <span
                    >{{ formatNumber(discussion.replies) }}
                    {{ languageService.getTranslation('replies') }}</span
                  >
                </div>
              }
            </div>
            <button class="panel-link forum-button" type="button">
              {{ languageService.getTranslation('visit_forum') }} &rarr;
            </button>
          </div>

          <div class="history card-panel">
            <div class="panel-head">
              <div>
                <h2>{{ languageService.getTranslation('donation_history') }}</h2>
                <p>{{ languageService.getTranslation('contributions_over_time') }}</p>
              </div>
            </div>
            <div class="history-items">
              @for (donation of donationHistory; track donation.date) {
                <div class="history-row">
                  <div>
                    <p class="history-date">{{ donation.date }}</p>
                    <span class="history-frequency">{{
                      getFrequencyTranslation(donation.frequency)
                    }}</span>
                  </div>
                  <span class="history-amount">{{
                    donation.amount | currency: 'USD' : 'symbol' : '1.0-0'
                  }}</span>
                </div>
              }
            </div>
            <button class="panel-link history-button" type="button">
              {{ languageService.getTranslation('view_full_history') }} &rarr;
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
